<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Member Booking Pass</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .card { border: 1px solid #ccc; padding: 16px; border-radius: 8px; }
    .green-card { background-color: #d4edda; border-color: #c3e6cb; color: #155724; }
    .white-card { background-color: #ffffff; border-color: #ccc; color: #333; }
  </style>
</head>
<body>
  <h1>Loading your pass...</h1>
  <div id="bookingCard">Please wait...</div>

  <script>
    async function generateSignature(customerId) {
        const cleanUserId = customerId.trim();
        const urlToSign = `/api/get-bookings?userid=${cleanUserId}`;
        const encoder = new TextEncoder();
        const keyData = encoder.encode('XxEKJ0_e86072gnm!28fDMtXjEf2w3NM');  // <-- Replace with your actual secret
        const key = await crypto.subtle.importKey("raw", keyData, { name: "HMAC", hash: "SHA-256" }, false, ["sign"]);
        const signature = await crypto.subtle.sign("HMAC", key, encoder.encode(urlToSign));
        const hashArray = Array.from(new Uint8Array(signature));
        return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    }

    $(async function () {
        function getParameterByName(name) {
            const url = window.location.href;
            name = name.replace(/[\[\]]/g, "\\$&");
            const regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)");
            const results = regex.exec(url);
            if (!results) return null;
            if (!results[2]) return '';
            return decodeURIComponent(results[2].replace(/\+/g, " "));
        }

        const customerId = getParameterByName('userid');

        if (!customerId) {
            $('#bookingCard').html("Missing userid parameter.");
            return;
        }

        let signature;
        try {
            signature = await generateSignature(customerId);
        } catch (err) {
            console.error("Signature generation error:", err);
            $('#bookingCard').html("Error generating secure request.");
            return;
        }

        fetch(`https://pass-cafe-gardens-backend-final.onrender.com/api/get-bookings?userid=${customerId}&hash=${signature}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    $('#bookingCard').html("Error: " + data.error);
                    return;
                }

                if (!data.bookings || data.bookings.length === 0) {
                    $('#bookingCard').html(`<div class="card white-card"><h3>No current booking</h3></div>`);
                    return;
                }

                const now = new Date();
                const booking = data.bookings[0];
                const fromTime = new Date(booking.FromTime);
                const toTime = new Date(booking.ToTime);

                // Add 15 min buffer before and after
                const early = new Date(fromTime.getTime() - 15 * 60000);
                const late = new Date(toTime.getTime() + 15 * 60000);

                if (now >= early && now <= late) {
                    $('#bookingCard').html(`
                        <div class="card green-card">
                            <h3>Garden & Caf√© Pass Active</h3>
                            <h4>Booking Details</h4>
                            <p><strong>Name:</strong> ${booking.CoworkerFullName}</p>
                            <p><strong>Resource:</strong> ${booking.ResourceName}</p>
                            <p><strong>Start:</strong> ${fromTime.toLocaleString()}</p>
                            <p><strong>End:</strong> ${toTime.toLocaleString()}</p>
                        </div>
                    `);
                } else {
                    $('#bookingCard').html(`<div class="card white-card"><h3>No current booking</h3></div>`);
                }
            })
            .catch(err => {
                console.error(err);
                $('#bookingCard').html("Error loading bookings.");
            });
    });
  </script>
</body>
</html>
