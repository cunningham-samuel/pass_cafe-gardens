<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Member Booking Pass</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: Arial, sans-serif;
      background-color: #f5f5f5;
    }

    .container {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
    }

    .card {
      width: 90%;
      max-width: 400px;
      height: 90%;
      border: 2px solid #ccc;
      border-radius: 20px;
      padding: 20px;
      box-sizing: border-box;
      text-align: center;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    .active {
      background-color: #4F615C;
      color: white;
    }

    .inactive {
      background-color: #ffffff;
      color: #333;
    }

    .dedicated {
      background-color: #4F615C;
      color: white;
    }

    .card h3 {
      font-size: 2rem;
      margin: 0;
      text-transform: capitalize;
      flex: 0 0 auto;
    }

    .details {
      font-size: 1.5rem;
      flex: 1 1 auto;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .details p {
      margin: 10px 0;
    }

    .image {
      flex: 0 0 auto;
      margin-top: 20px;
    }

    .image img {
      max-width: 100%;
      border-radius: 12px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div id="bookingCard">
      <div class="card inactive">
        <h3>Loading Your Pass...</h3>
      </div>
    </div>
  </div>

  <script>
    $(async function () {
        function getParameterByName(name) {
            const url = window.location.href;
            name = name.replace(/[\[\]]/g, "\\$&");
            const regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)");
            const results = regex.exec(url);
            if (!results) return null;
            if (!results[2]) return '';
            return decodeURIComponent(results[2].replace(/\+/g, " "));
        }

        const customerId = getParameterByName('userid');
        if (!customerId) {
            $('#bookingCard').html(`<div class="card inactive"><h3>Missing Userid Parameter</h3></div>`);
            return;
        }

        async function generateHash(userid, secret) {
            const encoder = new TextEncoder();
            const key = await crypto.subtle.importKey(
                "raw",
                encoder.encode(secret),
                { name: "HMAC", hash: "SHA-256" },
                false,
                ["sign"]
            );
            const signature = await crypto.subtle.sign("HMAC", key, encoder.encode(String(userid).trim()));
            return Array.from(new Uint8Array(signature)).map(b => b.toString(16).padStart(2, '0')).join('');
        }

        const sharedSecret = "XxEKJ0_e86072gnm!28fDMtXjEf2w3NM";
        const hash = await generateHash(customerId, sharedSecret);

        fetch(`https://pass-cafe-gardens-backend-final.onrender.com/api/get-bookings?userid=${customerId}&hash=${hash}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    $('#bookingCard').html(`<div class="card inactive"><h3>Error: ${data.error}</h3></div>`);
                    return;
                }

                if (data.dedicatedMember) {
                    $('#bookingCard').html(`
                        <div class="card dedicated">
                            <h3>Dedicated Desk Member</h3>
                            <div class="image"><img src="assets/images/coffee-in-plants.jpeg" alt="Coffee Image"></div>
                        </div>
                    `);
                    return;
                }

                if (!data.bookings || data.bookings.length === 0) {
                    $('#bookingCard').html(`<div class="card inactive"><h3>No Current Booking</h3></div>`);
                    return;
                }

                const now = new Date();
                const marginMinutes = 15;
                const activeBooking = data.bookings.find(booking => {
                    const start = new Date(booking.FromTime);
                    const end = new Date(booking.ToTime);
                    const startMargin = new Date(start.getTime() - marginMinutes * 60000);
                    const endMargin = new Date(end.getTime() + marginMinutes * 60000);
                    return now >= startMargin && now <= endMargin;
                });

                if (activeBooking) {
                    $('#bookingCard').html(`
                        <div class="card active">
                            <h3>Garden & Caf√© Pass Active</h3>
                            <div class="details">
                                <p><strong>Name:</strong> ${activeBooking.CoworkerFullName || 'N/A'}</p>
                                <p><strong>Resource:</strong> ${activeBooking.ResourceName}</p>
                                <p><strong>Start:</strong> ${new Date(activeBooking.FromTime).toLocaleString()}</p>
                                <p><strong>End:</strong> ${new Date(activeBooking.ToTime).toLocaleString()}</p>
                            </div>
                            <div class="image"><img src="assets/images/coffee-in-plants.jpeg" alt="Coffee Image"></div>
                        </div>
                    `);
                } else {
                    $('#bookingCard').html(`<div class="card inactive"><h3>No Current Booking</h3></div>`);
                }
            })
            .catch(err => {
                console.error(err);
                $('#bookingCard').html(`<div class="card inactive"><h3>Error Loading Pass</h3></div>`);
            });
    });
  </script>
</body>
</html>


