<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Garden & Café Pass</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .card { border: 1px solid #ccc; padding: 16px; border-radius: 8px; max-width: 400px; margin: 0 auto; }
    .active { background-color: #d4edda; border-color: #c3e6cb; color: #155724; }
    .inactive { background-color: #ffffff; border-color: #ccc; color: #333333; }
  </style>
</head>
<body>
  <h1>Loading your pass...</h1>
  <div id="bookingCard">Loading...</div>

  <script>
    $(function () {
        function getParameterByName(name) {
            const url = window.location.href;
            name = name.replace(/[\[\]]/g, "\\$&");
            const regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)");
            const results = regex.exec(url);
            if (!results) return null;
            if (!results[2]) return '';
            return decodeURIComponent(results[2].replace(/\+/g, " "));
        }

        const customerId = getParameterByName('userid');
        if (!customerId) {
            $('#bookingCard').html("Missing userid parameter.");
            return;
        }

        async function generateHash(userid, secret) {
            const encoder = new TextEncoder();
            const key = await crypto.subtle.importKey(
                "raw",
                encoder.encode(secret),
                { name: "HMAC", hash: "SHA-256" },
                false,
                ["sign"]
            );
            const signature = await crypto.subtle.sign("HMAC", key, encoder.encode(userid.toString().trim()));
            return Array.from(new Uint8Array(signature)).map(b => b.toString(16).padStart(2, '0')).join('');
        }

        const sharedSecret = "XxEKJ0_e86072gnm!28fDMtXjEf2w3NM";

        generateHash(customerId, sharedSecret).then(hash => {
            fetch(`https://pass-cafe-gardens-backend-final.onrender.com/api/get-bookings?userid=${customerId}&hash=${hash}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        $('#bookingCard').html("Error: " + data.error);
                        return;
                    }

                    if (!data.bookings || data.bookings.length === 0) {
                        $('#bookingCard').html("No bookings found.");
                        return;
                    }

                    const booking = data.bookings[0];

                    // Timezone-safe comparison
                    const nowMs = Date.now();
                    const fromMs = new Date(booking.FromTime).getTime();
                    const toMs = new Date(booking.ToTime).getTime();
                    const earlyMs = fromMs - 15 * 60 * 1000;
                    const lateMs = toMs + 15 * 60 * 1000;
                    const isActive = nowMs >= earlyMs && nowMs <= lateMs;

                    if (isActive) {
                        $('#bookingCard').html(`
                            <div class="card active">
                                <h2>Garden & Café Pass Active</h2>
                                <h3>Booking Details</h3>
                                <p><strong>Name:</strong> ${booking.CoworkerFullName || 'N/A'}</p>
                                <p><strong>Resource:</strong> ${booking.ResourceName}</p>
                                <p><strong>Start:</strong> ${new Date(fromMs).toLocaleString()}</p>
                                <p><strong>End:</strong> ${new Date(toMs).toLocaleString()}</p>
                            </div>
                        `);
                    } else {
                        $('#bookingCard').html(`
                            <div class="card inactive">
                                <h2>No Current Booking</h2>
                                <h3>Next Booking</h3>
                                <p><strong>Name:</strong> ${booking.CoworkerFullName || 'N/A'}</p>
                                <p><strong>Resource:</strong> ${booking.ResourceName}</p>
                                <p><strong>Start:</strong> ${new Date(fromMs).toLocaleString()}</p>
                                <p><strong>End:</strong> ${new Date(toMs).toLocaleString()}</p>
                            </div>
                        `);
                    }
                })
                .catch(err => {
                    console.error(err);
                    $('#bookingCard').html("Error loading bookings.");
                });
        });
    });
  </script>
</body>
</html>

