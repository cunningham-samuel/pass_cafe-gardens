<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Garden & Café Pass</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { 
      font-family: Arial, sans-serif; 
      padding: 20px; 
      background-color: #f9f9f9;
      margin: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }
    .card { 
      border: 1px solid #ccc; 
      padding: 20px; 
      border-radius: 12px; 
      max-width: 350px; 
      box-shadow: 0 4px 8px rgba(0,0,0,0.1); 
      text-align: center;
    }
    .active { 
      background-color: #d4edda; 
      border-color: #c3e6cb; 
    }
    .inactive { 
      background-color: #ffffff; 
      border-color: #ccc; 
    }
    .title { 
      font-size: 22px; 
      margin-bottom: 16px; 
    }
    .subtitle { 
      font-size: 18px; 
      margin-bottom: 12px; 
      color: #555;
    }
    p { margin: 6px 0; }
  </style>
</head>
<body>
  <div id="bookingCard">Loading your pass...</div>

  <script>
    $(function () {
        function getParameterByName(name) {
            const url = window.location.href;
            name = name.replace(/[\[\]]/g, "\\$&");
            const regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)");
            const results = regex.exec(url);
            if (!results) return null;
            if (!results[2]) return '';
            return decodeURIComponent(results[2].replace(/\+/g, " "));
        }

        const customerId = getParameterByName('userid');
        const hash = getParameterByName('hash');

        if (!customerId || !hash) {
            $('#bookingCard').html("Missing parameters.");
            return;
        }

        // Clean URL after params read (security + tidy)
        if (history.replaceState) {
            const cleanUrl = window.location.protocol + "//" + window.location.host + window.location.pathname;
            window.history.replaceState({}, document.title, cleanUrl);
        }

        fetch(`https://pass-cafe-gardens-backend-final.onrender.com/api/get-bookings?userid=${customerId}&hash=${hash}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    $('#bookingCard').html(`<div class="card inactive"><div class="title">Error</div><p>${data.error}</p></div>`);
                    return;
                }

                const now = new Date();
                const fifteenMinutes = 15 * 60 * 1000;
                let activeBooking = null;

                data.bookings.forEach(booking => {
                    const start = new Date(booking.FromTime).getTime() - fifteenMinutes;
                    const end = new Date(booking.ToTime).getTime() + fifteenMinutes;
                    if (now.getTime() >= start && now.getTime() <= end) {
                        activeBooking = booking;
                    }
                });

                if (activeBooking) {
                    $('#bookingCard').html(`
                        <div class="card active">
                            <div class="title">Garden & Café Pass Active</div>
                            <div class="subtitle">Booking Details</div>
                            <p><strong>Name:</strong> ${activeBooking.CoworkerFullName || "Unknown"}</p>
                            <p><strong>Resource:</strong> ${activeBooking.ResourceName}</p>
                            <p><strong>Start:</strong> ${new Date(activeBooking.FromTime).toLocaleString()}</p>
                            <p><strong>End:</strong> ${new Date(activeBooking.ToTime).toLocaleString()}</p>
                        </div>
                    `);
                } else {
                    $('#bookingCard').html(`
                        <div class="card inactive">
                            <div class="title">No Current Booking</div>
                        </div>
                    `);
                }
            })
            .catch(err => {
                console.error(err);
                $('#bookingCard').html(`<div class="card inactive"><div class="title">Error loading pass.</div></div>`);
            });
    });
  </script>
</body>
</html>
